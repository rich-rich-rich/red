<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <title>红色记忆 - 交互加固版</title>  
    <style>  
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Microsoft YaHei', serif; }  
        canvas { display: block; }  
        #ui-layer {  
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);  
            width: 90%; max-width: 800px; color: #fff; text-align: center;  
            pointer-events: none; opacity: 0; z-index: 100; transition: opacity 0.5s;
        }  
        .card-inner-box {  
            background: radial-gradient(circle at center, rgba(120, 0, 0, 0.9) 0%, rgba(20, 0, 0, 1) 100%);  
            padding: 40px; border-radius: 30px; border: 2px solid #ffcc00;  
            box-shadow: 0 0 50px rgba(0,0,0,1); backdrop-filter: blur(20px);  
        }  
        .card-title { font-size: 3em; color: #f3e5ab; margin-bottom: 15px; letter-spacing: 10px; font-weight: bold; }  
        .card-sub { font-size: 1.4em; color: #ffcc00; margin-bottom: 20px; }
        .card-desc { font-size: 1.2em; line-height: 1.8; color: #eee; border-top: 1px solid rgba(255,215,0,0.5); padding-top: 20px; }  
        #loading-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #ffcc00; font-size: 1.2em; }
    </style>  
</head>  
<body>  

<div id="loading-screen">正在唤醒记忆芯片，请准许摄像头权限...</div>  

<div id="ui-layer">  
    <div class="card-inner-box">  
        <div id="title" class="card-title"></div>  
        <div id="sub" class="card-sub"></div>
        <div id="desc" class="card-desc"></div>  
    </div> 
</div>  

<video id="video-input" style="display:none;" playsinline></video>  

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>  
// 数据保持不变
const rawData = [
    { name: "湘江战役", sub: "雄关漫道真如铁", desc: "湘江血雨虽寒，然星火不灭。后辈若逢困厄，当学此役之后，反思前路。" },
    { name: "遵义会议", sub: "东方欲晓，莫道君行早", desc: "遵义城头，风雨虽急，然灯塔已明，后辈若迷方向，当循此智。" },
    { name: "四渡赤水", sub: "你打你的，我打我的", desc: "别被外界的声音打乱脚步，坚持自己的节奏。" },
    { name: "巧渡金沙江", sub: "兵无常势，水无常形", desc: "遇到事情别死脑筋，换个角度想办法，路就活了。" },
    { name: "强渡大渡河", sub: "为有牺牲多壮志", desc: "把这份“换新天”的劲儿，用在让日子更像样上。" },
    { name: "飞夺泸定桥", sub: "狭路相逢勇者胜", desc: "别被吓住，稳住脚、往前闯。" },
    { name: "翻雪山", sub: "世上无难事，只要肯攀登", desc: "遇到难处别自己硬扛，和身边人搭把手。" },
    { name: "过草地", sub: "行到水穷处，坐看云起时", desc: "若遇困境，也别慌，停下来喘口气，等待新转机。" },
    { name: "吴起镇会师", sub: "数风流人物，还看今朝", desc: "这一路的跋涉，是为了让后来人能有好日子过。" },
    { name: "会宁会师", sub: "云程发轫，万里可期", desc: "认真过好每一天，照顾好身边人。" },
    { name: "开国大典", sub: "人间正道是沧桑", desc: "沧桑藏着所有不容易，也藏着走到底的底气。" },
    { name: "改革开放", sub: "病树前头万木春", desc: "找准了改革的新方向。旧的迷雾即将散去。" },
    { name: "经济特区", sub: "领异标新二月花", desc: "用“领异标新”的胆子去闯、去试，才有奔头。" },
    { name: "香港回归", sub: "运筹帷幄之中", desc: "提前准备，胸有成竹，稳稳当当做成。" },
    { name: "澳门回归", sub: "会当水击三千里", desc: "要坚信光明总有一天会来。" },
    { name: "加入世贸", sub: "敢为天下先", desc: "敢在未知中打开一扇门。闯过去了，就是新天地。" },
    { name: "青藏铁路", sub: "众人拾柴火焰高", desc: "再难的事，一群人抱成团就没有办不成的。" },
    { name: "北京奥运", sub: "人心齐，泰山移", desc: "个人的力量再强，也离不开身边人的托举。" },
    { name: "建党百年", sub: "星火已燎原", desc: "这盛世，比我们当年在篝火边聊的所有憧憬都要耀眼。" },
    { name: "长征胜利90周年", sub: "马年盛世入画屏", desc: "你们好好守着这“新境”，就是我们最盼的事。" }
];

let scene, camera, renderer, cardGroup, cards = [];
let lightPoint, particleSystem;
let raycaster = new THREE.Raycaster();
let isGrabbing = false, selectedCard = null, isAnimating = false;
let grabCounter = 0;
let rotationSpeed = 0.003, targetSpeed = 0.003;

// 1. 初始化场景
function initScene() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.z = 0;

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    // 2. 核心：强制立即创建小黄点
    const dotGeo = new THREE.SphereGeometry(0.18, 32, 32);
    const dotMat = new THREE.MeshBasicMaterial({ color: 0xffd700, depthTest: false }); 
    lightPoint = new THREE.Mesh(dotGeo, dotMat);
    lightPoint.position.set(0, 0, -5); // 初始位置在正前方
    lightPoint.renderOrder = 999; // 强制渲染在最前
    scene.add(lightPoint);

    const ambient = new THREE.AmbientLight(0xffffff, 2);
    scene.add(ambient);

    createCards();
    animate();
}

function createCards() {
    cardGroup = new THREE.Group();
    scene.add(cardGroup);
    const radius = 25;
    const cardGeo = new THREE.BoxGeometry(5, 7.5, 0.1);

    rawData.forEach((data, i) => {
        const angle = (i / rawData.length) * Math.PI * 2;
        const mat = new THREE.MeshStandardMaterial({ color: 0xaa0000 }); // 简化材质
        const card = new THREE.Mesh(cardGeo, mat);
        card.position.set(Math.sin(angle) * radius, 0, Math.cos(angle) * radius);
        card.lookAt(0, 0, 0);
        card.rotateY(Math.PI);
        card.userData = { angle, info: data };
        cards.push(card);
        cardGroup.add(card);
    });
}

// 3. 手势追踪修复
async function initTracking() {
    const videoElement = document.getElementById('video-input');
    const hands = new Hands({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7
    });

    hands.onResults((results) => {
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            const indexFinger = landmarks[8];
            const thumb = landmarks[4];

            // 映射坐标
            const x = (0.5 - indexFinger.x) * 12;
            const y = (0.5 - indexFinger.y) * 8;
            
            // 移动小黄点
            lightPoint.position.lerp(new THREE.Vector3(x, y, -10), 0.3);
            targetSpeed = x * 0.01;

            // 捏合检测
            const dist = Math.hypot(indexFinger.x - thumb.x, indexFinger.y - thumb.y);
            if (dist < 0.05) {
                grabCounter++;
                if (grabCounter > 5 && !isGrabbing) { 
                    isGrabbing = true; 
                    tryGrab(); 
                }
            } else {
                grabCounter = 0;
                if (isGrabbing) { 
                    isGrabbing = false; 
                    tryRelease(); 
                }
            }
        }
    });

    const camera = new Camera(videoElement, {
        onFrame: async () => {
            await hands.send({image: videoElement});
        },
        width: 640,
        height: 480
    });
    
    camera.start().then(() => {
        gsap.to('#loading-screen', { opacity: 0, duration: 1, onComplete: () => document.getElementById('loading-screen').remove() });
    }).catch(err => {
        document.getElementById('loading-screen').innerText = "摄像头启动失败，请检查权限。";
    });
}

function tryGrab() {
    if (isAnimating || selectedCard) return;
    const origin = new THREE.Vector3(0, 0, 0);
    const direction = lightPoint.position.clone().normalize();
    raycaster.set(origin, direction);
    
    const intersects = raycaster.intersectObjects(cards);
    if (intersects.length > 0) {
        isAnimating = true;
        selectedCard = intersects[0].object;
        
        document.getElementById('title').innerText = selectedCard.userData.info.name;
        document.getElementById('sub').innerText = selectedCard.userData.info.sub;
        document.getElementById('desc').innerText = selectedCard.userData.info.desc;

        gsap.to(selectedCard.position, { x: 0, y: 0, z: -15, duration: 1, ease: "power2.out" });
        gsap.to(selectedCard.rotation, { x: 0, y: 0, z: 0, duration: 1 });
        gsap.to('#ui-layer', { opacity: 1, duration: 0.5 });
        setTimeout(() => isAnimating = false, 1000);
    }
}

function tryRelease() {
    if (!selectedCard) return;
    isAnimating = true;
    gsap.to('#ui-layer', { opacity: 0, duration: 0.3 });
    
    const angle = selectedCard.userData.angle;
    gsap.to(selectedCard.position, { 
        x: Math.sin(angle) * 25, 
        y: 0, 
        z: Math.cos(angle) * 25, 
        duration: 0.8,
        onComplete: () => {
            selectedCard.lookAt(0,0,0);
            selectedCard.rotateY(Math.PI);
            selectedCard = null;
            isAnimating = false;
        }
    });
}

function animate() {
    requestAnimationFrame(animate);
    if (!selectedCard && !isAnimating) {
        rotationSpeed = THREE.MathUtils.lerp(rotationSpeed, targetSpeed, 0.05);
        cardGroup.rotation.y += rotationSpeed;
    }
    renderer.render(scene, camera);
}

// 启动
window.onload = () => {
    initScene();
    initTracking();
};

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script> 
</body> 
</html>
